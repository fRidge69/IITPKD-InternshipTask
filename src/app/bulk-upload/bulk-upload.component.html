<div class="outer">
<div class="card">
    <div class="d-flex text-center btn-group">
        <button class="w-100 btn {{currentStep === 1 ? 'btn-primary' : 'btn-light'}}" (click)="setCurrentStep(1)">Upload</button>
        <button class="w-100 btn {{currentStep === 2 ? 'btn-primary' : 'btn-light'}}" (click)="setCurrentStep(2)" [disabled]="uploadedData.length === 0">Preview &amp; Edit</button>
        <button class="w-100 btn {{currentStep === 3 ? 'btn-primary' : 'btn-light'}}" (click)="setCurrentStep(3)" [disabled]="uploadedData.length === 0">Export</button>
    </div>
    @if (currentStep === 1) {
        <div>
        <div class="p-2 d-flex flex-column align-items-center w-100 gap-4 outer">
            <span class="text-info-emphasis">Download the Latest Template: 
                <a href="{{TEMPLATE_SPREADSHEET_URL}}"><button class="btn btn-outline-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-xlsx" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M14 4.5V11h-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM7.86 14.841a1.13 1.13 0 0 0 .401.823q.195.162.479.252.284.091.665.091.507 0 .858-.158.355-.158.54-.44a1.17 1.17 0 0 0 .187-.656q0-.336-.135-.56a1 1 0 0 0-.375-.357 2 2 0 0 0-.565-.21l-.621-.144a1 1 0 0 1-.405-.176.37.37 0 0 1-.143-.299q0-.234.184-.384.188-.152.513-.152.214 0 .37.068a.6.6 0 0 1 .245.181.56.56 0 0 1 .12.258h.75a1.1 1.1 0 0 0-.199-.566 1.2 1.2 0 0 0-.5-.41 1.8 1.8 0 0 0-.78-.152q-.44 0-.777.15-.336.149-.527.421-.19.273-.19.639 0 .302.123.524t.351.367q.229.143.54.213l.618.144q.31.073.462.193a.39.39 0 0 1 .153.326.5.5 0 0 1-.085.29.56.56 0 0 1-.255.193q-.168.07-.413.07-.176 0-.32-.04a.8.8 0 0 1-.249-.115.58.58 0 0 1-.255-.384zm-3.726-2.909h.893l-1.274 2.007 1.254 1.992h-.908l-.85-1.415h-.035l-.853 1.415H1.5l1.24-2.016-1.228-1.983h.931l.832 1.438h.036zm1.923 3.325h1.697v.674H5.266v-3.999h.791zm7.636-3.325h.893l-1.274 2.007 1.254 1.992h-.908l-.85-1.415h-.035l-.853 1.415h-.861l1.24-2.016-1.228-1.983h.931l.832 1.438h.036z"/>
                    </svg>
                    xlsx</button></a>
                 | 
                <a href="{{TEMPLATE_CSV_URL}}"><button class="btn btn-outline-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-csv" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM3.517 14.841a1.13 1.13 0 0 0 .401.823q.195.162.478.252.284.091.665.091.507 0 .859-.158.354-.158.539-.44.187-.284.187-.656 0-.336-.134-.56a1 1 0 0 0-.375-.357 2 2 0 0 0-.566-.21l-.621-.144a1 1 0 0 1-.404-.176.37.37 0 0 1-.144-.299q0-.234.185-.384.188-.152.512-.152.214 0 .37.068a.6.6 0 0 1 .246.181.56.56 0 0 1 .12.258h.75a1.1 1.1 0 0 0-.2-.566 1.2 1.2 0 0 0-.5-.41 1.8 1.8 0 0 0-.78-.152q-.439 0-.776.15-.337.149-.527.421-.19.273-.19.639 0 .302.122.524.124.223.352.367.228.143.539.213l.618.144q.31.073.463.193a.39.39 0 0 1 .152.326.5.5 0 0 1-.085.29.56.56 0 0 1-.255.193q-.167.07-.413.07-.175 0-.32-.04a.8.8 0 0 1-.248-.115.58.58 0 0 1-.255-.384zM.806 13.693q0-.373.102-.633a.87.87 0 0 1 .302-.399.8.8 0 0 1 .475-.137q.225 0 .398.097a.7.7 0 0 1 .272.26.85.85 0 0 1 .12.381h.765v-.072a1.33 1.33 0 0 0-.466-.964 1.4 1.4 0 0 0-.489-.272 1.8 1.8 0 0 0-.606-.097q-.534 0-.911.223-.375.222-.572.632-.195.41-.196.979v.498q0 .568.193.976.197.407.572.626.375.217.914.217.439 0 .785-.164t.55-.454a1.27 1.27 0 0 0 .226-.674v-.076h-.764a.8.8 0 0 1-.118.363.7.7 0 0 1-.272.25.9.9 0 0 1-.401.087.85.85 0 0 1-.478-.132.83.83 0 0 1-.299-.392 1.7 1.7 0 0 1-.102-.627zm8.239 2.238h-.953l-1.338-3.999h.917l.896 3.138h.038l.888-3.138h.879z"/>
                    </svg>
                    csv</button></a></span>
            @if (uploadedData.length > 0) {
                <div class="d-flex align-items-center gap-4 w-100"><span class="text-info-emphasis">Uploaded {{uploadedData.length}} entries.</span><span class="badge bg-primary rounded-pill" placement="top" ngbTooltip="Upload entries with id to replace the uploaded data.">?</span></div>
            } @else {
                <span class="w-100 text-info-emphasis">No entries uploaded yet.</span>
            }
            <div class="position-relative w-100 ratio ratio-21x9 border-1 border upload"><app-upload-file [onFileUpload]="onFileUpload"></app-upload-file></div>
            <div class="w-25 btn-group ms-auto"><button class="btn btn-light" [disabled]="uploadedData.length === 0" (click)="uploadedData = []">Reset data</button><button class="btn btn-primary" [disabled]="uploadedData.length === 0" (click)="setCurrentStep(2)">Next</button></div>
        </div>
    </div>
    } @else if (currentStep === 2) {
        <div class="p-2 w-100 d-flex flex-column gap-4 outer">
            <div class="overflow-x-auto"><app-preview-table [uploadedData]="uploadedData" [columns]="columns" [revalidateEntry]="revalidateEntry"></app-preview-table></div>
            <div class="d-flex align-items-center justify-content-between">
                @if (uploadedDataHasNoErrors()) {
                    <div class="w-25 ms-auto btn-group">
                        <button class="btn btn-primary" (click)="setCurrentStep(3)">Next</button>
                    </div>
                } @else {
                    <div ngbDropdown class="d-inline-block w-100">
                        <button type="button" class="btn btn-outline-primary" id="download-errors" ngbDropdownToggle>
                            Download Erroneous Data
                        </button>
                        <div ngbDropdownMenu aria-labelledby="download-errors">
                            <button ngbDropdownItem (click)="getErrorEntrySheet('xlsx')"><img src="assets/icons/filetype-xlsx.svg" alt=""/> as .xlsx</button>
                            <button ngbDropdownItem (click)="getErrorEntrySheet('csv')"><img src="assets/icons/filetype-csv.svg" alt=""/> as .csv</button>
                        </div>
                    </div>
                    <div class="w-100 btn-group">
                        <button class="btn btn-light" (click)="setCurrentStep(1)" [disabled]="uploadedDataHasNoErrors()">&lt; Upload Corrected Entries</button>
                        <button class="btn btn-primary" (click)="setCurrentStep(3)">Next</button>
                    </div>
                }
            </div>
        </div>

        @if (showToast) {
            <ngb-toast header="Errors" (hidden)="showToast = false" class="fixed-top m-auto" style="top: 5rem">
              Validation complete. {{getTotalErrors()}} errors found in data.
            </ngb-toast>
          }
    } @else if (currentStep === 3) {
        <div class="p-2 d-flex flex-column align-items-center w-100 gap-4">
            <div class="container d-flex flex-column gap-5">
                <span>
                    Export all validated entries.
                </span>
                <span class="text-info">
                    @if (uploadedData.length === getExportData().length) {
                        All entries can be exported!
                    } @else {
                        Some entries have errors. {{getExportData().length}} / {{uploadedData.length}} entries can be exported.
                    }
                </span>
                <div class="btn-group ms-auto w-25">
                    <button class="btn btn-light" (click)="setCurrentStep(2)">&lt; Back</button>
                    <button class="btn btn-primary" (click)="exportData(getExportData())" [disabled]="isExporting">Export</button>
                </div>
            </div>
        </div>
    } @else if (currentStep === 4) {
        <div class="p-2 d-flex flex-column align-items-center w-100 gap-4">
            <div class="d-flex w-100 flex-column justify-content-center align-items-center p-3 border-1 border gap-4">
                <ngb-progressbar [value]="exportProgress" type="success" class="w-100"></ngb-progressbar>
                @if (isExporting) {
                    <span class="text-primary-emphasis">Exporting...</span>
                } @else {
                    <img src="assets/images/check-circle.svg" alt="success" class="w-25 opacity-75">
                    <span class="text-success-emphasis">Export successful!</span>
                }
            </div>
            @if (!isExporting) {
                <div class="w-25 btn-group ms-auto"><button class="btn btn-primary" (click)="setCurrentStep(1)">Upload More Entries</button></div>
            }
        </div>
    }
</div>
</div>
